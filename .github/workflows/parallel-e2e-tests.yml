name: Parallel E2E Tests

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - '.github/workflows/parallel-e2e-tests.yml'
      - 'frontend/e2e/**'
      - 'frontend/src/**'
      - 'src/**'
      - 'k8s/**'
  schedule:
    - cron: '0 2 * * *' # Daily at 2am UTC

jobs:
  # Tests en parall√®le - chaque fichier de test dans un job s√©par√©
  # Note: Chaque job ex√©cute un fichier de test sp√©cifique pour parall√©liser l'ex√©cution
  run-all-tests:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        test-suite:
          - { name: 'user-management', file: 'user-management.spec.ts' }
          - { name: 'api-integration', file: 'api-integration.spec.ts' }
          - { name: 'form-validation', file: 'form-validation.spec.ts' }
          - { name: 'ui-ux', file: 'ui-ux.spec.ts' }
          - { name: 'performance', file: 'performance.spec.ts' }
          - { name: 'accessibility', file: 'accessibility.spec.ts' }
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create Kind cluster
        uses: helm/kind-action@v1
        with:
          version: v0.20.0
          cluster_name: kind
          wait: 5m

      - name: Verify cluster
        run: |
          kubectl cluster-info
          kubectl get nodes
          echo "Cluster name: $(kind get clusters)"

      - name: Install NGINX Ingress
        run: |
          kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/main/deploy/static/provider/kind/deploy.yaml
          kubectl wait --namespace ingress-nginx \
            --for=condition=ready pod \
            --selector=app.kubernetes.io/component=controller \
            --timeout=120s

      - name: Deploy Infrastructure
        run: |
          # PostgreSQL
          kubectl apply -f k8s/postgres-secret.yaml
          kubectl apply -f k8s/postgres-config.yaml
          kubectl apply -f k8s/postgres-deployment.yaml
          kubectl apply -f k8s/postgres-service.yaml
          kubectl wait --for=condition=ready pod -l app=postgres --timeout=180s
          
          # Initialize DB
          kubectl apply -f k8s/reset-sql-config.yaml
          kubectl apply -f k8s/db-reset-job.yaml
          kubectl wait --for=condition=complete job/db-reset-job --timeout=120s || {
            echo "‚ùå DB reset failed"
            kubectl logs job/db-reset-job
            exit 1
          }
          
          # Build and load images
          echo "üèóÔ∏è Building API image..."
          docker build -t mini-api:latest .
          echo "üì¶ Loading API image into Kind cluster..."
          kind load docker-image mini-api:latest --name kind
          
          echo "üèóÔ∏è Building Frontend image..."
          cd frontend
          docker build -t mini-api-frontend:latest .
          echo "üì¶ Loading Frontend image into Kind cluster..."
          kind load docker-image mini-api-frontend:latest --name kind
          cd ..
          
          echo "‚úÖ Images loaded successfully"
          docker images | grep mini-api
          
          # Verify images are available in Kind
          echo "üîç Verifying images in Kind cluster..."
          docker exec kind-control-plane crictl images | grep mini-api || {
            echo "‚ö†Ô∏è Warning: Images might not be visible in Kind yet"
          }
          
          # Deploy API and Frontend
          echo "üöÄ Deploying API..."
          kubectl apply -f k8s/api-deployment.yaml
          kubectl apply -f k8s/api-service.yaml
          
          echo "‚è≥ Waiting for API pod to be ready..."
          kubectl wait --for=condition=ready pod -l app=mini-api --timeout=300s || {
            echo "‚ùå API deployment failed"
            kubectl get deployments
            kubectl get pods -l app=mini-api
            kubectl describe pod -l app=mini-api | tail -50
            kubectl logs -l app=mini-api --tail=50 || echo "No logs available"
            exit 1
          }
          
          echo "üöÄ Deploying Frontend..."
          kubectl apply -f k8s/frontend-deployment.yaml
          kubectl apply -f k8s/frontend-service.yaml
          
          echo "‚è≥ Waiting for Frontend pod to be ready..."
          kubectl wait --for=condition=ready pod -l app=mini-api-frontend --timeout=300s || {
            echo "‚ùå Frontend deployment failed"
            kubectl get deployments
            kubectl get pods -l app=mini-api-frontend
            kubectl describe pod -l app=mini-api-frontend | tail -50
            kubectl logs -l app=mini-api-frontend --tail=50 || echo "No logs available"
            exit 1
          }
          
          # Setup Ingress
          kubectl apply -f k8s/frontend-ingress.yaml
          sleep 30

      - name: Configure DNS
        run: |
          NODE_IP=$(kubectl get nodes -o jsonpath='{.items[0].status.addresses[?(@.type=="InternalIP")].address}')
          echo "$NODE_IP mini-api.local" | sudo tee -a /etc/hosts

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: Install Playwright Browsers
        working-directory: frontend
        run: npx playwright install --with-deps chromium

      - name: Run Tests - ${{ matrix.test-suite.name }}
        working-directory: frontend
        run: npx playwright test ${{ matrix.test-suite.file }} --reporter=json
        continue-on-error: true

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.test-suite.name }}
          path: |
            frontend/test-results/
            frontend/playwright-report/
          retention-days: 7
